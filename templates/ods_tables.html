<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaccination Coverage - Annual Data Tables</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: white;
            color: #000;
            font-size: 11pt;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .table-title {
            font-size: 13pt;
            font-weight: bold;
            margin: 20px 0 10px 0;
            color: #000;
        }

        .table-note {
            font-size: 9pt;
            color: #333;
            margin: 5px 0;
            line-height: 1.3;
        }

        .note-reference {
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 10pt;
        }

        th {
            background: #f2f2f2;
            padding: 8px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #ccc;
            position: relative;
        }

        th input,
        th select {
            width: 100%;
            margin-top: 5px;
            padding: 4px;
            font-size: 9pt;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        th select {
            max-height: 150px;
        }

        td {
            padding: 6px 8px;
            border: 1px solid #ddd;
        }

        .number-cell {
            text-align: right;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .controls {
            background: #f8f8f8;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .control-group {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }

        .control-group label {
            display: inline-block;
            margin-right: 8px;
            font-weight: bold;
            font-size: 10pt;
        }

        .control-group select {
            padding: 5px 10px;
            font-size: 10pt;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        button {
            padding: 6px 16px;
            font-size: 10pt;
            border: 1px solid #005eb8;
            background: #005eb8;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 8px;
        }

        button:hover {
            background: #004a94;
        }

        .btn-secondary {
            background: white;
            color: #005eb8;
        }

        .btn-secondary:hover {
            background: #f0f4f5;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #666;
            font-style: italic;
        }

        .empty-row {
            height: 10px;
        }

        /* Visualization section styles */
        .viz-section {
            margin-top: 40px;
            padding: 20px;
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .viz-controls {
            margin-bottom: 15px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
            min-height: 300px;
        }

        .chart-container img {
            max-width: 100%;
            height: auto;
        }

        /* CRUD section styles */
        .crud-section {
            margin-top: 40px;
            padding: 20px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
        }

        .crud-form {
            background: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .crud-form input {
            padding: 6px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .vaccine-list {
            background: white;
            padding: 15px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }

        .vaccine-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vaccine-item:hover {
            background: #f9f9f9;
        }

        .vaccine-actions button {
            padding: 4px 8px;
            font-size: 9pt;
            margin-left: 5px;
        }

        .section-toggle {
            cursor: pointer;
            user-select: none;
        }

        .section-toggle:hover {
            opacity: 0.8;
        }

        /* Summary statistics styles */
        .summary-stats {
            background: #f0f8ff;
            border: 1px solid #4682b4;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
        }

        .summary-stats h3 {
            margin: 0 0 10px 0;
            font-size: 11pt;
            color: #2c5282;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 3px;
            border-left: 3px solid #4682b4;
        }

        .stat-label {
            font-size: 9pt;
            color: #666;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 14pt;
            font-weight: bold;
            color: #2c5282;
        }

        /* Custom dropdown filter styles */
        .filter-dropdown {
            position: relative;
            width: 100%;
        }

        .filter-dropdown-toggle {
            width: 100%;
            padding: 4px;
            font-size: 9pt;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            text-align: left;
        }

        .filter-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            margin-top: 2px;
        }

        .filter-dropdown-menu.show {
            display: block;
        }

        .filter-option {
            padding: 4px 8px;
            font-size: 9pt;
            cursor: pointer;
        }

        .filter-option:hover {
            background: #f0f4f5;
        }

        .filter-option input[type="checkbox"] {
            margin-right: 6px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="table-title" style="font-size: 16pt; margin-bottom: 20px;">
            Vaccination Coverage Annual Data Tables 2024-2025
        </h1>

        <div class="controls">
            <div class="info-box"
                style="background-color: #e8f4fc; border: 1px solid #b6d4fe; padding: 10px; margin-bottom: 15px; border-radius: 4px; color: #084298;">
                <strong>üí° Quick Tip:</strong>
                You can <u>click on any data cell</u> in the table (coverage % or vaccinated count) to automatically
                populate the edit form below!
                This allows you to easily update specific records.
            </div>

            <div class="control-group">
                <label>Table:</label>
                <select id="table-select" onchange="loadTable()">
                    <option value="table1">Table 1 - National Coverage</option>
                    <option value="table4">Table 2 - Local Authority Coverage</option>
                </select>
            </div>
            <div class="control-group">
                <label>Cohort:</label>
                <select id="cohort-select">
                    <option value="12 months">12 months</option>
                    <option value="24 months">24 months</option>
                    <option value="5 years">5 years</option>
                </select>
            </div>
            <!-- Year hidden - only 2024 data available -->
            <input type="hidden" id="year-select" value="2024">
            <button onclick="loadTable()">Load Table</button>
            <button class="btn-secondary" onclick="exportTable()">Export CSV</button>
            <button class="btn-secondary" onclick="clearFilters()">Clear Filters</button>
            <button class="btn-warning" onclick="reloadOriginalData()"
                title="Reset database to original 2024-25 coverage data figures">üîÑ Reset to 2024-25 Data</button>
        </div>

        <div id="table-container">
            <div class="loading">Select a table and click "Load Table" to begin</div>
        </div>

        <!-- Notes Section -->
        <div id="notes-section"
            style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-left: 4px solid #4682b4; display: none;">
            <h3 style="margin-top: 0; font-size: 11pt;">Notes:</h3>
            <div id="notes-content"></div>
        </div>

        <!-- Visualization Section -->
        <div class="viz-section" id="viz-section" style="display: block;">
            <h2 class="table-title section-toggle" onclick="toggleSection('viz-content')">
                üìä Table Data Visualization (Click to Toggle)
            </h2>
            <div id="viz-content">
                <div class="viz-controls" id="viz-controls" style="display: none;">
                    <label for="area-search">Select Area to Visualize:</label>
                    <input list="area-list" id="area-search" placeholder="Type to search area..."
                        onchange="autoGenerateTableVisualization()" style="padding: 5px; width: 300px;">
                    <datalist id="area-list"></datalist>
                    <button class="btn-secondary"
                        onclick="document.getElementById('area-search').value=''; autoGenerateTableVisualization()">Clear</button>
                    <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                        Select a specific area to see its detailed vaccine coverage.
                    </div>
                </div>
                <div class="chart-container" id="chart-container">
                    <div class="loading">Loading visualization...</div>
                </div>
            </div>
        </div>

        <!-- CRUD Section (Row Editor) -->
        <div class="crud-section" id="crud-section">
            <h2 class="table-title section-toggle" onclick="toggleSection('crud-content')">
                ‚úèÔ∏è Manage Data (Row Editor)
            </h2>
            <div id="crud-content" style="display: none;">
                <div class="crud-form">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 id="crud-mode-title" style="margin: 0; font-size: 11pt;">Select a row to edit</h3>
                        <button class="secondary-btn" style="padding: 4px 10px; font-size: 0.9em;"
                            onclick="setupAddNew()">+ Add New Row</button>
                    </div>

                    <div id="crud-editor-container" style="display: none;">
                        <!-- Area Selection -->
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                            <label style="font-weight: bold; margin-right: 10px;">Area:</label>
                            <span id="crud-static-area" style="font-weight: bold; font-size: 1.1em;"></span>
                            <div id="crud-new-area-container" style="display: none; margin-top: 5px;">
                                <input list="crud-area-list" id="crud-area-input" placeholder="Search Area by Name..."
                                    style="width: 100%; padding: 5px;">
                                <datalist id="crud-area-list"></datalist>
                            </div>
                        </div>

                        <!-- Shared Cohort Population (if applicable) -->
                        <div id="crud-shared-pop-container" style="margin-bottom: 15px; display: none;">
                            <label>Eligible Population (Shared):</label>
                            <input type="number" id="crud-shared-pop" onchange="updateAllCoverages()"
                                style="width: 100px;">
                        </div>

                        <!-- Dynamic Vaccine Inputs -->
                        <div id="crud-vaccine-grid"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; max-height: 500px; overflow-y: auto;">
                            <!-- Injected via JS -->
                        </div>

                        <!-- Actions -->
                        <div
                            style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; display: flex; gap: 10px;">
                            <button class="primary-btn" onclick="saveRowData()">üíæ Save Row</button>
                            <button id="crud-delete-btn" class="danger-btn"
                                style="background-color: #dc3545; border-color: #dc3545;" onclick="deleteRowData()">üóëÔ∏è
                                Delete Row</button>
                            <button class="secondary-btn" onclick="cancelEdit()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTableData = null;
        let filteredData = null;
        let isAddMode = false;
        let currentAreaCode = null;

        async function loadTable() {
            const tableType = document.getElementById('table-select').value;
            const cohort = document.getElementById('cohort-select').value;
            const year = parseInt(document.getElementById('year-select').value);
            const container = document.getElementById('table-container');

            // Clear viz search on new table load
            document.getElementById('area-search').value = '';

            container.innerHTML = '<div class="loading">Loading table data...</div>';

            try {
                let response;
                let endpoint;
                let requestBody;

                if (tableType === 'table1') {
                    endpoint = '/api/tables/table1';
                    requestBody = { cohort_name: cohort, year: year };
                } else if (tableType === 'table4') {
                    endpoint = '/api/tables/utla';
                    requestBody = { cohort_name: cohort, year: year };
                } else if (tableType === 'table7') {
                    endpoint = '/api/tables/hepb';
                    requestBody = { year: year };
                } else if (tableType === 'table8') {
                    endpoint = '/api/tables/bcg';
                    requestBody = { year: year };
                }

                response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                currentTableData = result;
                filteredData = result.data;

                renderTable(result);

                // Populate area search list if table 4
                if (tableType === 'table4' && result.data) {
                    const dataList = document.getElementById('area-list');
                    dataList.innerHTML = '';
                    // Get unique area names
                    const areas = [...new Set(result.data.map(d => d.local_authority))].sort();
                    areas.forEach(area => {
                        const option = document.createElement('option');
                        option.value = area;
                        dataList.appendChild(option);
                    });
                }

            } catch (error) {
                container.innerHTML = `<div class="loading" style="color: red;">Error: ${error.message}</div>`;
            }
        }

        function calculateSummaryStats(data) {
            if (!data || data.length === 0) return null;

            const stats = {
                rowCount: data.length,
                vaccineStats: {}
            };

            // Get all columns from first row
            const firstRow = data[0];
            const coverageColumns = Object.keys(firstRow).filter(col => col.startsWith('coverage_at_'));

            // Calculate stats for each coverage column
            coverageColumns.forEach(col => {
                const values = data
                    .map(row => row[col])
                    .filter(val => val !== null && val !== undefined && !isNaN(val));

                if (values.length > 0) {
                    const sum = values.reduce((a, b) => a + b, 0);
                    const avg = sum / values.length;
                    const min = Math.min(...values);
                    const max = Math.max(...values);

                    // Extract vaccine name from column
                    const vaccineName = col
                        .replace(/coverage_at_\d+_months_/, '')
                        .replace(/coverage_at_\d+_years_/, '')
                        .replace(/_/g, '/');

                    stats.vaccineStats[vaccineName] = {
                        avg: avg.toFixed(1),
                        min: min.toFixed(1),
                        max: max.toFixed(1),
                        count: values.length
                    };
                }
            });

            return stats;
        }

        function renderTable(tableData) {
            const container = document.getElementById('table-container');

            // Title
            let html = `<div class="table-title">${tableData.title}</div>`;

            // Notes
            html += '<div class="table-note">This worksheet contains one table. Some cells may refer to notes which can be found on the Notes worksheet.</div>';

            if (tableData.notes && tableData.notes.length > 0) {
                tableData.notes.forEach(note => {
                    const noteRef = note.match(/\[.*?\]/)?.[0] || '';
                    const noteText = note.replace(/\[.*?\]\s*/, '');
                    html += `<div class="table-note"><span class="note-reference">${noteRef}</span> ${noteText}</div>`;
                });
            }

            // Summary Statistics
            const stats = calculateSummaryStats(filteredData);
            if (stats) {
                html += '<div class="summary-stats">';
                html += '<h3>üìä Summary Statistics</h3>';
                html += '<div class="stats-grid">';

                // Row count
                html += '<div class="stat-item">';
                html += '<div class="stat-label">Total Rows</div>';
                html += `<div class="stat-value">${stats.rowCount.toLocaleString()}</div>`;
                html += '</div>';

                // Vaccine statistics
                Object.keys(stats.vaccineStats).forEach(vaccine => {
                    const vStats = stats.vaccineStats[vaccine];
                    html += '<div class="stat-item">';
                    html += `<div class="stat-label">${vaccine} Coverage</div>`;
                    html += `<div class="stat-value">Avg: ${vStats.avg}%</div>`;
                    html += `<div style="font-size: 8pt; color: #666;">Min: ${vStats.min}% | Max: ${vStats.max}%</div>`;
                    html += '</div>';
                });

                html += '</div></div>';
            }

            // Table
            if (filteredData && filteredData.length > 0) {
                // Get all columns from first row
                const firstRow = filteredData[0];
                const allColumns = Object.keys(firstRow);

                // Filter out completely empty columns
                const nonEmptyColumns = allColumns.filter(col => {
                    // Check if any row has a non-empty value for this column
                    return filteredData.some(row => {
                        const val = row[col];
                        return val !== null && val !== undefined && val !== '';
                    });
                });

                let columns;

                // Define column order dynamically
                const currentTable = document.getElementById('table-select').value;

                if (currentTable === 'table1') {
                    // Table 1: geographic_area, note, number_aged_X, then coverage columns
                    const fixedCols = ['geographic_area', 'note'];
                    const numberCol = nonEmptyColumns.filter(col => col.startsWith('number_aged_'));
                    const coverageCols = nonEmptyColumns.filter(col => col.startsWith('coverage_at_'));
                    columns = [...fixedCols, ...numberCol, ...coverageCols].filter(c => nonEmptyColumns.includes(c));
                } else if (currentTable === 'table4') {
                    // Table 4: code, local_authority, region_name, ods_code, note, number_aged_X, then vaccine columns
                    const fixedCols = ['code', 'local_authority', 'region_name', 'note'];
                    const numberCol = nonEmptyColumns.filter(col => col.startsWith('number_aged_'));
                    const vaccineCols = nonEmptyColumns.filter(col =>
                        col.startsWith('vaccinated_at_') || col.startsWith('coverage_at_')
                    ).sort(); // Sort to get vaccinated/coverage pairs together
                    columns = [...fixedCols, ...numberCol, ...vaccineCols].filter(c => nonEmptyColumns.includes(c));
                } else {
                    // For other tables, use natural order from data
                    columns = nonEmptyColumns;
                }

                // Store visible columns for Row Editor
                window.currentColumns = columns;

                html += '<table id="data-table">';

                html += '<thead><tr>';
                columns.forEach(col => {
                    let displayName = col;

                    // Custom mappings for specific columns
                    if (col === 'geographic_area') {
                        displayName = 'Geographic area';
                    } else if (col === 'local_authority') {
                        displayName = 'Local Authority';
                    } else if (col === 'note') {
                        displayName = 'Note';
                    } else if (col === 'code') {
                        displayName = 'Code';
                    } else if (col === 'ods_code') {
                        displayName = 'ODS Code';
                    } else if (col === 'region_name') {
                        displayName = 'Region';
                    } else if (col === 'number_aged_12_months') {
                        displayName = 'Number aged 12 months';
                    } else if (col === 'eligible_population') {
                        displayName = 'Eligible Population';
                    } else if (col.startsWith('vaccinated_at_12_months_')) {
                        const vaccineName = col.replace('vaccinated_at_12_months_', '').replace(/_/g, '/');
                        displayName = `Vaccinated at 12 months ${vaccineName}`;
                    } else if (col.startsWith('coverage_at_12_months_')) {
                        const vaccineName = col.replace('coverage_at_12_months_', '').replace(/_/g, '/');
                        displayName = `Coverage at 12 months ${vaccineName} (%)`;
                    } else if (col.startsWith('coverage_at_24_months_')) {
                        const vaccineName = col.replace('coverage_at_24_months_', '').replace(/_/g, '/');
                        displayName = `Coverage at 24 months ${vaccineName} (%)`;
                    } else if (col.startsWith('coverage_at_5_years_')) {
                        const vaccineName = col.replace('coverage_at_5_years_', '').replace(/_/g, '/');
                        displayName = `Coverage at 5 years ${vaccineName} (%)`;
                    } else if (col.startsWith('coverage_') && !col.includes('_at_')) {
                        // For Table 4 UTLA coverage columns like "coverage_DTaP_IPV_Hib_HepB"
                        const vaccineName = col.replace('coverage_', '').replace(/_/g, '/');
                        displayName = `Coverage ${vaccineName} (%)`;
                    } else if (col.startsWith('eligible_')) {
                        // For special program tables
                        const cohort = col.replace('eligible_', '').replace(/_/g, ' ');
                        displayName = `Eligible ${cohort}`;
                    } else if (col.startsWith('vaccinated_')) {
                        // For special program tables
                        const cohort = col.replace('vaccinated_', '').replace(/_/g, ' ');
                        displayName = `Vaccinated ${cohort}`;
                    } else {
                        // Fallback: capitalize first letter of each word
                        displayName = col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    }
                    displayName = displayName
                        .replace('Coverage At', 'Coverage at')
                        .replace('Vaccinated At', 'Vaccinated at')
                        .replace('Number Aged', 'Number aged');
                    html += `\u003cth\u003e${displayName}\u003c/th\u003e`;
                });
                html += '\u003c/tr\u003e\u003ctr\u003e';

                // Filter row with custom dropdowns
                columns.forEach(col => {
                    // Check if this is a vaccine data column (no filtering on these)
                    const isVaccineColumn = col.includes('coverage') || col.includes('vaccinated') || col.includes('number_aged') || col.includes('eligible');

                    if (isVaccineColumn) {
                        // No filter for vaccine columns
                        html += `\u003cth style=\"font-weight: normal; padding: 4px;\"\u003e\u003c/th\u003e`;
                    } else {
                        // Get unique values for this column
                        const uniqueValues = [...new Set(
                            filteredData
                                .map(row => row[col])
                                .filter(val => val !== null && val !== undefined && val !== '')
                                .map(val => typeof val === 'number' ? val.toFixed(1) : String(val))
                        )].sort();

                        if (uniqueValues.length > 50) {
                            // For huge value lists, use text input
                            html += `\u003cth style=\"font-weight: normal; padding: 4px;\"\u003e
                                \u003cinput type=\"text\" placeholder=\"Filter...\" data-column=\"${col}\" onkeyup=\"filterColumn(this, '${col}')\" /\u003e
                            \u003c/th\u003e`;
                        } else {
                            // For categorical columns, use custom dropdown with checkboxes
                            const dropdownId = `filter-${col.replace(/[^a-zA-Z0-9]/g, '_')}`;
                            html += `\u003cth style=\"font-weight: normal; padding: 4px;\"\u003e
                                \u003cdiv class=\"filter-dropdown\" data-column=\"${col}\"\u003e
                                    \u003cbutton type=\"button\" class=\"filter-dropdown-toggle\" onclick=\"toggleFilterDropdown('${dropdownId}')\"\u003e
                                        Select... \u003cspan class=\"filter-count\"\u003e\u003c/span\u003e
                                    \u003c/button\u003e
                                    \u003cdiv id=\"${dropdownId}\" class=\"filter-dropdown-menu\"\u003e`;
                            uniqueValues.forEach(val => {
                                const safeVal = val.replace(/"/g, '&quot;');
                                html += `\u003cdiv class=\"filter-option\"\u003e
                                    \u003clabel\u003e\u003cinput type=\"checkbox\" value=\"${safeVal}\" onchange=\"applyDropdownFilter('${col}')\"\u003e ${val}\u003c/label\u003e
                                \u003c/div\u003e`;
                            });
                            html += `\u003c/div\u003e\u003c/div\u003e\u003c/th\u003e`;
                        }
                    }
                });
                html += '\u003c/tr\u003e\u003c/thead\u003e';

                // Data rows
                html += '\u003ctbody\u003e';
                filteredData.forEach((row, index) => {
                    html += `<tr onclick="editRow(${index})" style="cursor: pointer;" title="Click to Edit Row" data-index="${index}">`;
                    columns.forEach(col => {
                        const value = row[col];
                        let displayValue = value;
                        let cellClass = '';

                        if (value === null || value === undefined) {
                            displayValue = '';
                        } else if (typeof value === 'number') {
                            if (col.includes('coverage')) {
                                displayValue = value.toFixed(1);
                            } else {
                                displayValue = value.toLocaleString();
                            }
                            cellClass = 'number-cell';
                        }

                        html += `<td class="${cellClass}">${displayValue}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody>';

                // Empty row for spacing (like in ODS)
                html += '<tr class="empty-row"><td colspan="' + columns.length + '"></td></tr>';

                html += '</table>';
            } else {
                html += '<div class="loading">No data available</div>';
            }

            container.innerHTML = html;

            // Display notes if available
            const notesSection = document.getElementById('notes-section');
            const notesContent = document.getElementById('notes-content');

            if (currentTableData.notes && currentTableData.notes.length > 0) {
                let notesHtml = '\u003cul style="margin: 5px 0; padding-left: 25px;"\u003e';
                currentTableData.notes.forEach(note => {
                    notesHtml += `\u003cli style="margin: 5px 0;"\u003e${note}\u003c/li\u003e`;
                });
                notesHtml += '\u003c/ul\u003e';
                notesContent.innerHTML = notesHtml;
                notesSection.style.display = 'block';
            } else {
                notesSection.style.display = 'none';
            }

            // Auto-generate visualization after rendering table
            autoGenerateTableVisualization();
        }

        function toggleFilterDropdown(dropdownId) {
            // Close all other dropdowns
            document.querySelectorAll('.filter-dropdown-menu').forEach(menu => {
                if (menu.id !== dropdownId) {
                    menu.classList.remove('show');
                }
            });

            // Toggle this dropdown
            const menu = document.getElementById(dropdownId);
            if (menu) {
                menu.classList.toggle('show');
            }
        }

        function applyDropdownFilter(columnName) {
            filterColumn(null, columnName);
        }

        function updateDropdownButtonText(columnName) {
            const dropdown = document.querySelector(`.filter-dropdown[data-column="${columnName}"]`);
            if (!dropdown) return;

            const button = dropdown.querySelector('.filter-dropdown-toggle');
            const checkedCount = dropdown.querySelectorAll('input[type="checkbox"]:checked').length;

            if (checkedCount === 0) {
                button.innerHTML = 'Select... <span class="filter-count"></span>';
            } else {
                button.innerHTML = `Select... <span class="filter-count">(${checkedCount})</span>`;
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.filter-dropdown')) {
                document.querySelectorAll('.filter-dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        // Store current filter state
        let currentFilters = {};

        async function filterColumn(input, columnName) {
            if (!currentTableData || !currentTableData.data) return;

            // Collect all current filters (both text inputs and multi-selects)
            const filters = {};

            // Text inputs
            document.querySelectorAll('th input[data-column]').forEach(inp => {
                const col = inp.getAttribute('data-column');
                if (col && inp.value.trim()) {
                    // For text inputs, we'll do client-side filtering for now
                    // (Could extend backend to support partial matches)
                    filters[col] = [inp.value.trim()];
                }
            });

            // Checkbox dropdowns
            document.querySelectorAll('.filter-dropdown[data-column]').forEach(dropdown => {
                const col = dropdown.getAttribute('data-column');
                const checkedBoxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');
                const selectedValues = Array.from(checkedBoxes).map(cb => cb.value);
                if (col && selectedValues.length > 0) {
                    filters[col] = selectedValues;
                }
            });

            // Store filters for state restoration
            currentFilters = filters;

            // Call backend to filter data using fs_analysis module
            try {
                const tableType = document.getElementById('table-select').value;
                const cohort = document.getElementById('cohort-select').value;
                const year = parseInt(document.getElementById('year-select').value);

                let endpoint = '';
                if (tableType === 'table1') {
                    endpoint = '/api/tables/table1';
                } else if (tableType === 'table4') {
                    endpoint = '/api/tables/utla';
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cohort_name: cohort,
                        year: year,
                        filters: filters  // Send filters to backend
                    })
                });

                const result = await response.json();
                currentTableData = result;
                filteredData = result.data;

                // Re-render table with backend-filtered data
                renderTable(currentTableData);
                restoreFilters();

                // Log backend filtering usage for debugging
                console.log(`[BACKEND FILTER] Applied ${Object.keys(filters).length} filters, returned ${filteredData.length} rows`);

            } catch (error) {
                console.error('Backend filtering error:', error);
                // Fallback to client-side if backend fails
                applyClientSideFiltering(filters);
            }
        }

        function applyClientSideFiltering(filters) {
            // Fallback client-side filtering in case backend fails
            filteredData = currentTableData.data.filter(row => {
                for (const [col, filterValues] of Object.entries(filters)) {
                    const cellValue = row[col];
                    const cellStr = cellValue !== null && cellValue !== undefined ?
                        (typeof cellValue === 'number' ? cellValue.toFixed(1) : String(cellValue)) : '';

                    // For text inputs, check if cellStr includes the filter value (case-insensitive)
                    if (filterValues.length === 1 && document.querySelector(`th input[data-column="${col}"]`)) {
                        if (!cellStr.toLowerCase().includes(filterValues[0].toLowerCase())) {
                            return false;
                        }
                    } else { // For multiselect dropdowns
                        if (!filterValues.includes(cellStr)) {
                            return false;
                        }
                    }
                }
                return true;
            });

            renderTable(currentTableData);
            restoreFilters();
        }

        function restoreFilters() {
            // Restore text input values
            document.querySelectorAll('th input[data-column]').forEach(inp => {
                const col = inp.getAttribute('data-column');
                if (currentFilters[col] && Array.isArray(currentFilters[col]) && currentFilters[col].length === 1) {
                    inp.value = currentFilters[col][0];
                }
            });

            // Restore checkbox selections in dropdowns
            document.querySelectorAll('.filter-dropdown[data-column]').forEach(dropdown => {
                const col = dropdown.getAttribute('data-column');
                if (currentFilters[col] && Array.isArray(currentFilters[col])) {
                    const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        cb.checked = currentFilters[col].includes(cb.value);
                    });
                    updateDropdownButtonText(col);
                }
            });
        }

        function clearFilters() {
            if (!currentTableData) return;

            // Reset filter state
            currentFilters = {};
            filteredData = currentTableData.data;
            renderTable(currentTableData);

            // Clear all input fields
            document.querySelectorAll('th input').forEach(input => {
                input.value = '';
            });

            // Clear all checkbox dropdowns
            document.querySelectorAll('.filter-dropdown input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });

            // Update all dropdown button texts
            document.querySelectorAll('.filter-dropdown[data-column]').forEach(dropdown => {
                const col = dropdown.getAttribute('data-column');
                updateDropdownButtonText(col);
            });
        }

        function exportTable() {
            if (!filteredData || filteredData.length === 0) {
                alert('No data to export. Please load a table first.');
                return;
            }

            // Convert to CSV
            const columns = Object.keys(filteredData[0]);
            let csv = columns.join(',') + '\n';

            filteredData.forEach(row => {
                const values = columns.map(col => {
                    const val = row[col];
                    if (val === null || val === undefined) return '';
                    if (typeof val === 'string' && val.includes(',')) return `"${val}"`;
                    return val;
                });
                csv += values.join(',') + '\n';
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vaccination_table_${new Date().getTime()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Auto-load table on page load
        window.onload = function () {
            loadTable();
            loadReferenceData();
        };

        // ===== VISUALIZATION FUNCTIONS =====
        async function autoGenerateTableVisualization() {
            console.log("[VIZ] autoGenerateTableVisualization called");

            if (!currentTableData || !filteredData || filteredData.length === 0) {
                console.log("[VIZ] No table data, hiding viz section");
                document.getElementById('viz-section').style.display = 'none';
                return;
            }

            const tableType = document.getElementById('table-select').value;
            console.log(`[VIZ] Table type: ${tableType} `);

            // Show visualization for table1 and table4
            if (tableType !== 'table1' && tableType !== 'table4') {
                console.log("[VIZ] Table type not supported for viz, hiding");
                document.getElementById('viz-section').style.display = 'none';
                return;
            }

            // Show visualization section
            document.getElementById('viz-section').style.display = 'block';
            console.log("[VIZ] Showing viz section");

            // Show/Hide area selector controls
            const vizControls = document.getElementById('viz-controls');
            if (tableType === 'table4') {
                vizControls.style.display = 'block';
            } else {
                vizControls.style.display = 'none';
            }

            const cohort = document.getElementById('cohort-select').value;
            const year = parseInt(document.getElementById('year-select').value);
            const container = document.getElementById('chart-container');

            // Handle Table 4 Area Selection
            let selectedAreas = [];
            if (tableType === 'table4') {
                const searchVal = document.getElementById('area-search').value;
                if (!searchVal) {
                    container.innerHTML = '<div class="loading" style="padding: 20px;">Please select an area from the search box above to visualize vaccine coverage.</div>';
                    return; // Stop here if no area selected for Table 4
                }
                selectedAreas = [searchVal];
            } else {
                // For Table 1, use all rows present
                selectedAreas = filteredData.map(row =>
                    row.geographic_area || row.local_authority || 'Unknown'
                );
                console.log(`[VIZ] Table 1 - Selected areas: ${selectedAreas.join(', ')} `);
            }

            // Get all coverage columns from the table
            const firstRow = filteredData[0];
            const selectedVaccines = Object.keys(firstRow).filter(col => col.startsWith('coverage_at_'));

            console.log(`[VIZ] Found ${selectedVaccines.length} coverage columns: `, selectedVaccines);

            if (selectedVaccines.length === 0) {
                console.error("[VIZ] No vaccine coverage columns found!");
                container.innerHTML = '<div class="loading">No vaccine coverage data available in this table</div>';
                return;
            }

            container.innerHTML = '<div class="loading">Generating visualization...</div>';

            try {
                const requestData = {
                    table_type: tableType,
                    cohort_name: cohort,
                    year: year,
                    selected_areas: selectedAreas,
                    selected_vaccines: selectedVaccines
                };

                console.log("[VIZ] Sending request:", requestData);

                const response = await fetch('/api/visualize/table-comparison', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                console.log(`[VIZ] Response status: ${response.status} `);

                if (!response.ok) {
                    const text = await response.text();
                    console.error(`[VIZ] Server error: `, text);
                    throw new Error(`Server Error(${response.status}): ${text.substring(0, 100)}...`);
                }

                const result = await response.json();
                console.log("[VIZ] Response data:", result);

                if (result.error) {
                    console.error(`[VIZ] Error from server: ${result.error}`);
                    container.innerHTML = `<div class="loading" style="color: red;">Error: ${result.error}</div>`;
                } else {
                    const timestamp = new Date().getTime();
                    const chartUrl = `${result.chart_url}?t=${timestamp}`;
                    console.log(`[VIZ] Loading chart from: ${chartUrl}`);
                    container.innerHTML = `<img src="${chartUrl}" alt="Table comparison chart" />`;
                }

            } catch (error) {
                console.error("[VIZ] Exception:", error);
                container.innerHTML = `<div class="loading" style="color: red;">
            Error generating chart.<br>
            <small>${error.message}</small>
                </div>`;
            }
        }

        // Global maps for Area matching
        window.areaMap = {}; // Name -> Code
        window.areaCodeMap = {}; // Code -> Name

        async function loadReferenceData() {
            try {
                // Load Areas
                const aResponse = await fetch('/api/areas');
                const areas = await aResponse.json();
                const areaList = document.getElementById('crud-area-list');

                window.areaMap = {};
                window.areaCodeMap = {};

                if (areaList) areaList.innerHTML = '';

                areas.forEach(a => {
                    // Populate maps
                    window.areaMap[a.name] = a.code;
                    window.areaCodeMap[a.code] = a.name;

                    if (areaList) {
                        const option = document.createElement('option');
                        option.value = a.name;
                        areaList.appendChild(option);
                    }
                });
            } catch (error) {
                console.error("Error loading ref data:", error);
            }
        }

        // ===== ROW EDITOR FUNCTIONS =====

        function editRow(index) {
            const row = filteredData[index];
            if (!row) return;

            isAddMode = false;
            currentAreaCode = row['code'];
            const areaName = row['local_authority'] || row['geographic_area'] || 'Unknown Area';

            // UI Setup
            document.getElementById('crud-mode-title').textContent = "Editing " + areaName;
            document.getElementById('crud-static-area').textContent = areaName;
            document.getElementById('crud-static-area').style.display = 'inline-block';
            document.getElementById('crud-new-area-container').style.display = 'none';
            document.getElementById('crud-delete-btn').style.display = 'inline-block';
            document.getElementById('crud-editor-container').style.display = 'block';

            // Generate Inputs
            generateRowInputs(row);

            // Expand and Scroll
            const content = document.getElementById('crud-content');
            if (content.style.display === 'none') {
                content.style.display = 'block';
            }
            document.getElementById('crud-section').scrollIntoView({ behavior: 'smooth' });
        }

        function setupAddNew() {
            isAddMode = true;
            currentAreaCode = null;

            // UI Setup
            document.getElementById('crud-mode-title').textContent = "Add New Record Row";
            document.getElementById('crud-static-area').style.display = 'none';
            document.getElementById('crud-new-area-container').style.display = 'block';
            document.getElementById('crud-area-input').value = '';
            document.getElementById('crud-delete-btn').style.display = 'none';
            document.getElementById('crud-editor-container').style.display = 'block';

            // Generate Empty Inputs based on columns of the first row (if exists) or current columns
            // We use filteredData[0] as template, or just currentTableData keys
            let templateRow = {};
            if (filteredData && filteredData.length > 0) {
                templateRow = { ...filteredData[0] };
                // Clear values
                Object.keys(templateRow).forEach(key => templateRow[key] = null);
            }

            generateRowInputs(templateRow);

            // Expand
            const content = document.getElementById('crud-content');
            if (content.style.display === 'none') {
                content.style.display = 'block';
            }
        }

        function generateRowInputs(row) {
            const container = document.getElementById('crud-vaccine-grid');
            container.innerHTML = '';

            // 1. Identify Shared Population (Table 4)
            // Look for 'number_aged_X'
            const popKeys = Object.keys(row).filter(k => k.startsWith('number_aged_'));
            if (popKeys.length > 0) {
                const popVal = row[popKeys[0]];
                document.getElementById('crud-shared-pop').value = popVal;
                document.getElementById('crud-shared-pop-container').style.display = 'block';
                document.getElementById('crud-shared-pop').setAttribute('data-key', popKeys[0]);
            } else {
                document.getElementById('crud-shared-pop-container').style.display = 'none';
            }

            // 2. Identify Vaccines
            // We group by "vaccine suffix" found in coverage_at_X_Vaccine
            const vaccinesFound = new Set();
            const cols = Object.keys(row);

            cols.forEach(col => {
                if (col.startsWith('coverage_at_') || col.startsWith('vaccinated_at_')) {
                    // Extract vaccine code
                    // Pattern: ..._months_CODE or ..._years_CODE
                    let code = null;
                    if (col.includes('_months_')) code = col.split('_months_')[1];
                    else if (col.includes('_years_')) code = col.split('_years_')[1];

                    if (code) vaccinesFound.add(code);
                }
            });

            // 3. Create Inputs for each Vaccine
            // Filter vaccines to ONLY those present in the current visible columns
            let sortedVaccines = [];

            const visibleVaccines = Array.from(vaccinesFound).filter(vCode => {
                const cohort = document.getElementById('cohort-select').value.replace(' ', '_');
                const expectedCol = `coverage_at_${cohort}_${vCode}`;

                // Allow if simple match
                if (window.currentColumns && window.currentColumns.includes(expectedCol)) return true;

                // Also allow if there is a vaccinated column
                const expectedVacCol = `vaccinated_at_${cohort}_${vCode}`;
                if (window.currentColumns && window.currentColumns.includes(expectedVacCol)) return true;

                return false;
            });

            sortedVaccines = visibleVaccines.sort();

            if (sortedVaccines.length === 0 && vaccinesFound.size > 0) {
                // Fallback: if filtering hid everything (e.g. logic mismatch), show all
                // This prevents "empty editor" bug if column names differ slightly
                console.warn("Row Editor: Filtering hid all vaccines. Showing all found in data.");
                sortedVaccines = Array.from(vaccinesFound).sort();
            }

            sortedVaccines.forEach(vCode => {
                // Find matching keys
                // We assume current cohort is active one in table columns
                const cohort = document.getElementById('cohort-select').value.replace(' ', '_');

                const covKey = cols.find(c => c === `coverage_at_${cohort}_${vCode}`);
                const vacKey = cols.find(c => c === `vaccinated_at_${cohort}_${vCode}`);

                let covVal = covKey ? row[covKey] : '';
                let vacVal = vacKey ? row[vacKey] : '';

                // Display Name
                const displayName = vCode.replace(/_/g, '/'); // DTaP_IPV -> DTaP/IPV

                const card = document.createElement('div');
                card.className = "vaccine-card";
                card.style.border = "1px solid #ddd";
                card.style.padding = "10px";
                card.style.borderRadius = "4px";
                card.style.backgroundColor = "#fff";

                card.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 8px; color: #084298;">${displayName}</div>
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label style="font-size: 0.8em; display: block;">Vaccinated</label>
                    <input type="number" class="row-vac-input" data-vaccine="${vCode}" value="${vacVal !== null ? vacVal : ''}" style="width: 100%; border: 1px solid #ccc; padding: 4px;" onchange="updateRowCoverage(this)">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 0.8em; display: block;">Coverage %</label>
                    <input type="number" class="row-cov-input" data-vaccine="${vCode}" value="${covVal !== null ? covVal : ''}" step="0.1" style="width: 100%; border: 1px solid #ccc; padding: 4px; background: #f9f9f9;" readonly>
                </div>
            </div>
                `;
                container.appendChild(card);
            });
        }

        function updateAllCoverages() {
            // Updated shared population
            const inputs = document.querySelectorAll('.row-vac-input');
            inputs.forEach(input => updateRowCoverage(input));
        }

        function updateRowCoverage(vacInput) {
            // Find sibling coverage input
            const parent = vacInput.closest('.vaccine-card');
            const covInput = parent.querySelector('.row-cov-input');

            // Get Eligible Pop
            const popInput = document.getElementById('crud-shared-pop');
            const eligible = parseFloat(popInput.value);
            const vaccinated = parseFloat(vacInput.value);

            if (eligible > 0 && !isNaN(vaccinated)) {
                const cov = (vaccinated / eligible) * 100;
                covInput.value = cov.toFixed(1);
            } else {
                // If pop is missing or vaccinated is empty
                if (vaccinated === 0) covInput.value = '0.0';
            }
        }

        function cancelEdit() {
            document.getElementById('crud-editor-container').style.display = 'none';
            document.getElementById('crud-mode-title').textContent = "Select a row to edit";
            isAddMode = false;
        }

        async function saveRowData() {
            try {
                console.log("saveRowData called");
                // 1. Get Area Code
                let areaCode = currentAreaCode;
                if (isAddMode) {
                    const nameInput = document.getElementById('crud-area-input').value;
                    areaCode = window.areaMap[nameInput];
                    if (!areaCode) {
                        alert('Please select a valid Area');
                        return;
                    }
                }

                // 2. Get Shared Data
                const cohort = document.getElementById('cohort-select').value; // from main select
                const year = parseInt(document.getElementById('year-select').value);
                const popInput = document.getElementById('crud-shared-pop');
                const eligible = popInput ? popInput.value : null;

                // 3. Collect Vaccine Updates
                const updates = [];
                const cards = document.querySelectorAll('.vaccine-card');

                cards.forEach(card => {
                    const vacInput = card.querySelector('.row-vac-input');
                    const covInput = card.querySelector('.row-cov-input');
                    const vCode = vacInput.getAttribute('data-vaccine'); // Do NOT replace underscores, DB uses them!

                    updates.push({
                        vaccine_code: vCode,
                        eligible_population: eligible,
                        vaccinated_count: vacInput.value,
                        coverage_percentage: covInput.value
                    });
                });

                const payload = {
                    area_code: areaCode,
                    year: year,
                    cohort_name: cohort,
                    vaccine_data: updates
                };

                try {
                    const response = await fetch('/api/crud/row', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const res = await response.json();
                    if (response.ok) {
                        alert('Row Saved: ' + res.message);
                        cancelEdit();
                        loadTable();
                    } else {
                        alert('Error: ' + res.error);
                    }
                } catch (e) {
                    console.error(e);
                    alert('Error saving: ' + e.message);
                }
            } catch (outerE) {
                console.error("Critical error in saveRowData wrapper:", outerE);
                alert('Critical script error: ' + outerE.message);
            }
        }

        async function deleteRowData() {
            if (!currentAreaCode) return;
            if (!confirm('Are you sure you want to delete ALL data for this area?')) return;

            const cohort = document.getElementById('cohort-select').value;
            const year = parseInt(document.getElementById('year-select').value);

            try {
                const response = await fetch('/api/crud/row', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        area_code: currentAreaCode,
                        year: year,
                        cohort_name: cohort
                    })
                });
                const res = await response.json();
                if (response.ok) {
                    alert('Row Deleted');
                    cancelEdit();
                    loadTable();
                }
            } catch (e) {
                alert('Error deleting: ' + e.message);
            }
        }


        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        async function reloadOriginalData() {
            // Confirm action
            if (!confirm('‚ö†Ô∏è This will reset the database to the original 2024-25 coverage data figures and undo any edits you made.\n\nAre you sure you want to continue?')) {
                return;
            }

            try {
                // Show loading message
                const tableContainer = document.getElementById('table-container');
                tableContainer.innerHTML = '<div class="loading">üîÑ Resetting database to 2024-25 coverage data... This may take a moment...</div>';

                // Call reload endpoint
                const response = await fetch('/api/reload-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (response.ok) {
                    alert('‚úÖ ' + result.message + '\n\nThe page will now reload.');
                    // Reload current table to show fresh data
                    window.location.reload();
                } else {
                    alert('‚ùå Error: ' + (result.error || 'Failed to reload data'));
                    loadTable(); // Reload current view
                }

            } catch (error) {
                console.error('Reload error:', error);
                alert('‚ùå Error reloading data: ' + error.message);
                loadTable(); // Try to reload current view
            }
        }
    </script>
</body>

</html>